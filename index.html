<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TOEIC 750+ è½åŠ›åå°„æ•™ç·´</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230f172a%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ğŸ§</text></svg>">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRPRUlDIDc1MCsgQ29hY2giLAogICJzaG9ydF9uYW1lIjogIlRPRUlDIFJlZmxleCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzNhIiwKICAidGhlbWVfY29sb3IiOiAiIzBmMTczYSIsCiAgImljb25zIjogW3sKICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sOzY0LDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+OpywvdGV4dD48L3N2Zz4iLAogICAgInNpemVzIjogIjE5MngxOTIiLAogICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICB9XQp9">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text { background: linear-gradient(to right, #4ade80, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ipa-text { font-family: 'Arial', sans-serif; color: #94a3b8; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #334155; border-radius: 99px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -7px; border: 2px solid #1e293b; }
        
        audio { height: 30px; width: 100%; border-radius: 15px; margin-top: 5px; }
        audio::-webkit-media-controls-panel { background-color: #1e293b; }
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display { color: #fff; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center p-4">

    <header class="w-full max-w-2xl mt-2 mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">TOEIC <span class="gradient-text">Reflex</span></h1>
            <p class="text-slate-400 text-[10px]">è½èªªé›™ä¿®ãƒ»èªéŸ³åå°„æ•™ç·´</p>
        </div>
        <div class="flex gap-2">
            <button id="wakeLockBtn" class="text-slate-500 hover:text-yellow-400 p-2 transition" title="ä¿æŒè¢å¹•å¸¸äº®"><i class="fas fa-lightbulb"></i></button>
            <button id="configBtn" class="text-slate-400 hover:text-white p-2"><i class="fas fa-cog fa-lg"></i></button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="apiKeyPanel" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold mb-4">è¨­å®š API Key</h3>
            <label class="block text-xs text-slate-400 mb-2">Gemini API Key <span class="text-red-400">(å¿…å¡«)</span></label>
            <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500" placeholder="Paste key here...">
            <div class="text-[10px] text-slate-500 mt-2 mb-4">
                * è«‹è‡³ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">Google AI Studio</a> ç”³è«‹ã€‚Key åƒ…å„²å­˜æ–¼æ‚¨çš„æ‰‹æ©Ÿç«¯ã€‚
            </div>
            <div class="flex gap-2">
                <button id="closeConfigBtn" class="flex-1 bg-slate-700 hover:bg-slate-600 text-sm font-bold py-2 rounded-lg transition">å–æ¶ˆ</button>
                <button id="saveKeyBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-sm font-bold py-2 rounded-lg transition">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Drill Score Modal -->
    <div id="drillScoreModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-blue-500/50 p-6 rounded-2xl max-w-sm w-full shadow-2xl transform transition-all scale-100">
            <div class="text-center">
                <h3 class="text-lg font-bold text-white mb-1">ç‰¹è¨“è©•åˆ†</h3>
                <p id="drillTargetText" class="text-sm text-slate-400 mb-4 font-mono"></p>
                
                <div id="drillScoreDisplay" class="text-5xl font-black gradient-text mb-4">--</div>
                <p id="drillComment" class="text-sm text-slate-300 bg-slate-900/50 p-3 rounded-lg text-left leading-relaxed"></p>
            </div>
            <button class="mt-6 w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold" onclick="document.getElementById('drillScoreModal').classList.add('hidden')">ç¹¼çºŒç·´ç¿’</button>
        </div>
    </div>

    <main class="w-full max-w-2xl space-y-6 flex-1 pb-20">
        
        <div id="httpsWarning" class="hidden bg-yellow-500/20 border border-yellow-500/50 text-yellow-200 p-4 rounded-xl text-sm">
            <i class="fas fa-exclamation-triangle mr-2"></i> <strong>éƒ¨ç½²éŒ¯èª¤ï¼š</strong> è«‹ä½¿ç”¨ Vercel æˆ– Netlify (HTTPS)ã€‚
        </div>

        <!-- 1. å‡ºé¡Œå€ -->
        <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-2xl p-5 shadow-xl">
            <div class="flex gap-2 mb-4">
                <select id="levelSelect" class="bg-slate-900 border border-slate-700 text-sm rounded-lg px-2 py-2 outline-none w-full truncate font-bold text-blue-200">
                    <option value="L1">L1: èªéŸ³æ‰‹è¡“ (é€£éŸ³/è®ŠéŸ³)</option>
                    <option value="L2">L2: ç¯€å¥çŒè¼¸ (é‡éŸ³/èªèª¿)</option>
                    <option value="L3">L3: è·Ÿè®€æ¨¡ä»¿ (Part 3/4)</option>
                    <option value="L4">L4: é€Ÿåº¦æŠ—å£“ (1.2x)</option>
                </select>
                <button id="generateBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-2 rounded-lg transition whitespace-nowrap flex items-center gap-2 shadow-lg shadow-blue-900/20">
                    <i class="fas fa-magic"></i><span>å‡ºé¡Œ</span>
                </button>
            </div>

            <div id="contentArea" class="min-h-[120px] flex flex-col justify-center items-center text-center space-y-4">
                <p class="text-slate-500 text-sm italic">è¼¸å…¥ Key å¾Œé»æ“Šã€Œå‡ºé¡Œã€é–‹å§‹è¨“ç·´</p>
            </div>
        </div>

        <!-- 2. é€£éŸ³æ‹†è§£ç‰¹è¨“ (Drills) - ENLARGED & INDEPENDENT -->
        <div id="drillSection" class="hidden animate-fade-in">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-sm font-bold text-blue-400 uppercase tracking-wider border-l-4 border-blue-500 pl-2">Step 1: é€£éŸ³ç‰¹è¨“</span>
                <div class="h-px bg-slate-700 flex-1"></div>
            </div>
            <div id="drillContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <!-- Drills injected here -->
            </div>
        </div>

        <!-- 3. æ•´å¥æŒ‘æˆ° (Full Sentence) -->
        <div id="mainPracticeSection" class="hidden animate-fade-in opacity-50 transition-opacity duration-500">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-sm font-bold text-green-400 uppercase tracking-wider border-l-4 border-green-500 pl-2">Step 2: æ•´å¥æŒ‘æˆ°</span>
                <div class="h-px bg-slate-700 flex-1"></div>
            </div>

            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 space-y-4">
                <div class="flex items-center gap-3">
                    <span class="text-xs text-slate-400 font-medium whitespace-nowrap"><i class="fas fa-tachometer-alt mr-1"></i></span>
                    <input type="range" id="rateInput" min="0.5" max="1.5" step="0.1" value="1" class="w-full">
                    <span id="rateValue" class="text-xs text-blue-400 font-mono w-8 text-right">1.0x</span>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="ttsBtn" class="bg-slate-700 active:bg-slate-600 text-white py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation">
                        <i id="speakerIcon" class="fas fa-volume-up text-xl"></i><span class="text-xs mt-1">è½æ•´å¥</span>
                    </button>
                    <button id="recordBtn" class="bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation">
                        <i id="micIcon" class="fas fa-microphone text-xl"></i><span id="recordText" class="text-xs mt-1">éŒ„æ•´å¥</span>
                    </button>
                </div>

                <!-- Live Transcript & Audio Check -->
                <div id="recordingArea" class="hidden space-y-3 pt-2 border-t border-slate-700/50">
                    <div class="bg-slate-900 p-3 rounded-lg border border-slate-800 min-h-[3rem] flex flex-col justify-center">
                        <p id="userSaidDisplay" class="text-red-400 text-base font-medium break-words text-center">...</p>
                    </div>
                    
                    <div id="audioPlayerContainer" class="hidden">
                        <audio id="userAudio" controls playsinline class="w-full h-8"></audio>
                    </div>

                    <!-- Manual Analysis Button (New!) -->
                    <button id="analyzeBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-900/30 flex items-center justify-center gap-2 transition transform active:scale-95 hidden">
                        <i class="fas fa-stethoscope"></i> é–‹å§‹æ•™ç·´è¨ºæ–·
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. è¨ºæ–·çµæœ (Feedback) -->
        <div id="feedbackSection" class="hidden space-y-4 animate-fade-in">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl p-5 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-quote-right text-6xl"></i></div>
                <div class="flex justify-between items-end mb-4 border-b border-slate-700 pb-4 relative z-10">
                    <div>
                        <h3 class="font-bold text-slate-200 text-sm">ç¶œåˆè©•åˆ†</h3>
                        <div class="flex gap-2 mt-1 text-[10px] text-slate-400">
                            <span>æº–ç¢ºåº¦: <span id="accuracyScore" class="text-white font-mono">--</span></span>
                            <span>|</span>
                            <span>æµæš¢åº¦: <span id="fluencyScore" class="text-white font-mono">--</span></span>
                        </div>
                    </div>
                    <div id="scoreDisplay" class="text-5xl font-black gradient-text">--</div>
                </div>
                
                <div class="space-y-4 relative z-10">
                    <div class="bg-red-900/10 border border-red-900/30 rounded-lg p-3">
                        <h4 class="text-red-400 text-xs font-bold mb-2 flex items-center gap-2"><i class="fas fa-user-md"></i> å¼±é»è™•æ–¹</h4>
                        <ul id="weaknessList" class="text-slate-300 text-sm space-y-1 list-disc list-inside"></ul>
                    </div>
                    <div id="geminiAnalysis" class="text-slate-300 text-sm leading-relaxed bg-slate-900/50 p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- 5. å­¸ç¿’é‡é» (Learning) -->
        <div id="learningSection" class="hidden space-y-4 animate-fade-in pb-10">
            <div class="bg-blue-900/10 border border-blue-800/50 rounded-2xl p-5">
                <div class="space-y-3">
                    <div>
                        <h3 class="text-blue-400 font-bold text-xs uppercase tracking-wider mb-1"><i class="fas fa-star mr-1"></i>è½åŠ›è€ƒé»</h3>
                        <p id="examPointDisplay" class="text-slate-200 text-sm font-medium leading-relaxed"></p>
                    </div>
                    <div class="h-px bg-blue-800/30"></div>
                    <div>
                        <h3 class="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1"><i class="fas fa-book mr-1"></i>æ–‡æ³•çµæ§‹</h3>
                        <div id="grammarNote" class="text-slate-300 text-xs space-y-1 leading-relaxed"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        const LEAKED_KEY_PREFIX = 'AIzaSyCvFOB';
        
        // Main State
        let currentSentence = '';
        let currentMode = 'full'; // 'full' or 'drill'
        let currentDrillText = '';
        
        // Recording State
        let isRecording = false;
        let isProcessing = false;
        let recognition = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;
        let transcriptBuffer = ''; // For stable final result

        // TTS State
        let currentUtterance = null;
        let availableVoices = [];

        const elements = {
            configBtn: document.getElementById('configBtn'),
            wakeLockBtn: document.getElementById('wakeLockBtn'),
            apiKeyPanel: document.getElementById('apiKeyPanel'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveKeyBtn: document.getElementById('saveKeyBtn'),
            closeConfigBtn: document.getElementById('closeConfigBtn'),
            
            generateBtn: document.getElementById('generateBtn'),
            levelSelect: document.getElementById('levelSelect'),
            contentArea: document.getElementById('contentArea'),
            
            drillSection: document.getElementById('drillSection'),
            drillContainer: document.getElementById('drillContainer'),
            drillScoreModal: document.getElementById('drillScoreModal'),
            drillTargetText: document.getElementById('drillTargetText'),
            drillScoreDisplay: document.getElementById('drillScoreDisplay'),
            drillComment: document.getElementById('drillComment'),

            mainPracticeSection: document.getElementById('mainPracticeSection'),
            rateInput: document.getElementById('rateInput'),
            rateValue: document.getElementById('rateValue'),
            ttsBtn: document.getElementById('ttsBtn'),
            speakerIcon: document.getElementById('speakerIcon'),
            recordBtn: document.getElementById('recordBtn'),
            recordText: document.getElementById('recordText'),
            micIcon: document.getElementById('micIcon'),
            
            recordingArea: document.getElementById('recordingArea'),
            userSaidDisplay: document.getElementById('userSaidDisplay'),
            audioPlayerContainer: document.getElementById('audioPlayerContainer'),
            userAudio: document.getElementById('userAudio'),
            analyzeBtn: document.getElementById('analyzeBtn'),

            feedbackSection: document.getElementById('feedbackSection'),
            scoreDisplay: document.getElementById('scoreDisplay'),
            accuracyScore: document.getElementById('accuracyScore'),
            fluencyScore: document.getElementById('fluencyScore'),
            weaknessList: document.getElementById('weaknessList'),
            geminiAnalysis: document.getElementById('geminiAnalysis'),

            learningSection: document.getElementById('learningSection'),
            examPointDisplay: document.getElementById('examPointDisplay'),
            grammarNote: document.getElementById('grammarNote'),
        };

        // --- Init ---
        function populateVoices() { availableVoices = window.speechSynthesis.getVoices(); }
        populateVoices();
        if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = populateVoices;

        function checkKey() {
            if (apiKey && apiKey.startsWith(LEAKED_KEY_PREFIX)) { apiKey = ''; localStorage.removeItem('gemini_api_key'); }
            if (apiKey) {
                elements.apiKeyInput.value = apiKey;
                elements.contentArea.innerHTML = `<div class="text-slate-500 text-sm italic animate-pulse"><i class="fas fa-check-circle text-green-500 mr-2"></i>æ•™ç·´å·²å°±ç·’ï¼Œè«‹é»æ“Šã€Œå‡ºé¡Œã€</div>`;
            } else {
                elements.apiKeyPanel.classList.remove('hidden');
            }
        }
        checkKey();

        if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            document.getElementById('httpsWarning').classList.remove('hidden');
        }

        // --- Event Listeners ---
        elements.configBtn.addEventListener('click', () => elements.apiKeyPanel.classList.remove('hidden'));
        elements.closeConfigBtn.addEventListener('click', () => elements.apiKeyPanel.classList.add('hidden'));
        elements.saveKeyBtn.addEventListener('click', () => {
            const val = elements.apiKeyInput.value.trim();
            if (val) {
                if (val.startsWith(LEAKED_KEY_PREFIX)) { alert("Key å·²å¤±æ•ˆ"); return; }
                apiKey = val;
                localStorage.setItem('gemini_api_key', apiKey);
                elements.apiKeyPanel.classList.add('hidden');
                checkKey();
            } else { alert('è«‹è¼¸å…¥ Key'); }
        });

        elements.rateInput.addEventListener('input', (e) => elements.rateValue.textContent = e.target.value + 'x');
        elements.generateBtn.addEventListener('click', generateSentence);
        elements.ttsBtn.addEventListener('click', () => speak(currentSentence));
        
        // Manual Analysis Trigger
        elements.analyzeBtn.addEventListener('click', () => {
            const text = elements.userSaidDisplay.innerText;
            if (text && text !== '...') {
                analyzePronunciation(text);
                // Scroll to results
                setTimeout(() => elements.feedbackSection.scrollIntoView({behavior:'smooth'}), 100);
            } else {
                alert("æœªåµæ¸¬åˆ°æ–‡å­—ï¼Œè«‹é‡æ–°éŒ„éŸ³");
            }
        });

        elements.recordBtn.addEventListener('click', async () => {
            if (isRecording) stopAllRecording();
            else startAllRecording('full');
        });

        elements.wakeLockBtn.addEventListener('click', async () => {
            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); elements.wakeLockBtn.classList.add('text-yellow-400'); alert("è¢å¹•å¸¸äº®ï¼šON"); } catch (err) { console.error(err); }
            }
        });

        // --- Drill UI Builder ---
        function renderDrills(drills) {
            elements.drillContainer.innerHTML = '';
            if (!drills || drills.length === 0) return;

            drills.forEach((d, idx) => {
                const card = document.createElement('div');
                card.className = "bg-slate-800 border border-slate-700 rounded-xl p-4 flex flex-col items-center gap-3 relative overflow-hidden";
                card.innerHTML = `
                    <div class="text-center">
                        <div class="text-lg font-bold text-white mb-1">${d.text}</div>
                        <div class="text-xs text-blue-400 font-mono tracking-wider bg-blue-900/20 px-2 py-1 rounded border border-blue-900/50">${d.visual || d.ipa}</div>
                    </div>
                    <div class="flex gap-2 w-full mt-1">
                        <button onclick="speak('${d.text}')" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-xs flex items-center justify-center gap-1">
                            <i class="fas fa-volume-up"></i> è½ç¯„ä¾‹
                        </button>
                        <button id="drill-rec-${idx}" class="flex-1 bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white border border-red-600/50 py-2 rounded-lg text-xs flex items-center justify-center gap-1 transition">
                            <i class="fas fa-microphone"></i> ç·´ç‰¹è¨“
                        </button>
                    </div>
                `;
                elements.drillContainer.appendChild(card);

                // Bind Drill Record Event
                document.getElementById(`drill-rec-${idx}`).addEventListener('click', (e) => {
                    // If already recording this drill, stop it
                    if (isRecording && currentMode === 'drill' && currentDrillText === d.text) {
                        stopAllRecording();
                        e.currentTarget.classList.remove('bg-red-600', 'text-white', 'animate-pulse');
                        e.currentTarget.classList.add('bg-red-600/20', 'text-red-400');
                        e.currentTarget.innerHTML = '<i class="fas fa-microphone"></i> ç·´ç‰¹è¨“';
                    } else {
                        // Stop any previous recording
                        if (isRecording) stopAllRecording();
                        
                        // Start new drill recording
                        startAllRecording('drill', d.text);
                        e.currentTarget.classList.remove('bg-red-600/20', 'text-red-400');
                        e.currentTarget.classList.add('bg-red-600', 'text-white', 'animate-pulse');
                        e.currentTarget.innerHTML = '<i class="fas fa-stop"></i> åœæ­¢';
                        
                        // Reset other buttons visual state
                        // (Optional: loop through others to reset)
                    }
                });
            });
            elements.drillSection.classList.remove('hidden');
        }

        // --- Recording Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        async function startAllRecording(mode = 'full', targetText = '') {
            if (!SpeechRecognition) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
            if (isProcessing) return;

            currentMode = mode;
            if (mode === 'drill') currentDrillText = targetText;

            try {
                // UI Prep
                if (mode === 'full') {
                    elements.recordingArea.classList.remove('hidden');
                    elements.analyzeBtn.classList.add('hidden'); // Hide analyze btn until done
                    elements.audioPlayerContainer.classList.add('hidden');
                    elements.recordBtn.className = "bg-red-600 text-white border border-red-600 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation shadow-lg shadow-red-900/50";
                    elements.micIcon.classList.add('animate-pulse');
                    elements.recordText.textContent = 'åœæ­¢éŒ„éŸ³';
                    elements.userSaidDisplay.textContent = '...';
                }

                // Audio Stream
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // MediaRecorder
                audioChunks = [];
                const mime = getMimeType();
                try { mediaRecorder = new MediaRecorder(audioStream, mime ? {mimeType:mime} : undefined); }
                catch(e) { mediaRecorder = new MediaRecorder(audioStream); }
                
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    elements.userAudio.src = URL.createObjectURL(blob);
                    if (mode === 'full') elements.audioPlayerContainer.classList.remove('hidden');
                    audioStream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();

                // Speech Recognition
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                transcriptBuffer = '';

                recognition.onresult = (event) => {
                    let finalStr = '';
                    let interimStr = '';
                    for (let i = 0; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) finalStr += event.results[i][0].transcript;
                        else interimStr += event.results[i][0].transcript;
                    }
                    transcriptBuffer = finalStr || interimStr; // Mobile Fallback
                    
                    if (mode === 'full') {
                        elements.userSaidDisplay.innerHTML = `<span class="text-white">${finalStr}</span><span class="text-slate-500">${interimStr}</span>`;
                    }
                };

                recognition.onerror = (e) => {
                    console.error(e);
                    if (isRecording && e.error !== 'no-speech') stopAllRecording();
                };

                recognition.start();
                isRecording = true;

            } catch (err) {
                console.error(err);
                alert("ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨: " + err.message);
                // Reset UI
                if(mode==='full') {
                    elements.recordBtn.className = "bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation";
                    elements.micIcon.classList.remove('animate-pulse');
                    elements.recordText.textContent = 'é»æ“ŠéŒ„éŸ³';
                }
            }
        }

        function stopAllRecording() {
            isRecording = false;
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (recognition) recognition.stop();

            // UI Reset & Logic
            if (currentMode === 'full') {
                elements.recordBtn.className = "bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation";
                elements.micIcon.classList.remove('animate-pulse');
                elements.recordText.textContent = 'é‡éŒ„æ•´å¥';
                
                // Show Analyze Button if text exists
                setTimeout(() => {
                    const text = elements.userSaidDisplay.innerText.trim();
                    if (text && text !== '...') elements.analyzeBtn.classList.remove('hidden');
                }, 800);

            } else if (currentMode === 'drill') {
                // Reset ALL drill buttons visual
                document.querySelectorAll('[id^="drill-rec-"]').forEach(btn => {
                    btn.className = "flex-1 bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white border border-red-600/50 py-2 rounded-lg text-xs flex items-center justify-center gap-1 transition";
                    btn.innerHTML = '<i class="fas fa-microphone"></i> ç·´ç‰¹è¨“';
                });

                // Auto Analyze for Drill
                setTimeout(() => {
                    if (transcriptBuffer.trim()) {
                        analyzeDrill(transcriptBuffer, currentDrillText);
                    } else {
                        alert("æ²’è½åˆ°è²éŸ³ï¼Œè«‹é‡è©¦");
                    }
                }, 800);
            }
        }

        const getMimeType = () => {
            const types = ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
            for (const t of types) if (MediaRecorder.isTypeSupported(t)) return t;
            return '';
        };

        // --- Gemini Functions ---
        async function generateSentence() {
            if (isProcessing) return;
            if (!apiKey) { elements.apiKeyPanel.classList.remove('hidden'); return; }
            
            isProcessing = true;
            elements.generateBtn.disabled = true;
            elements.contentArea.innerHTML = '<div class="loading-dots text-slate-500">æ•™ç·´å‡ºé¡Œä¸­</div>';
            
            // Hide previous
            elements.drillSection.classList.add('hidden');
            elements.mainPracticeSection.classList.add('hidden'); // Step 2 hidden initially
            elements.learningSection.classList.add('hidden');
            elements.feedbackSection.classList.add('hidden');
            elements.generateBtn.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');

            const prompt = `
                Act as a TOEIC coach. Level: ${elements.levelSelect.value}.
                Task: Generate a business English sentence.
                
                Return JSON only:
                {
                    "sentence": "English sentence",
                    "ipa": "IPA",
                    "translation": "TC translation",
                    "tips": "Brief tip",
                    "grammar": "Grammar (TC)",
                    "exam_point": "Exam point (TC)",
                    "drills": [
                        {"text": "segment1", "visual": "seg-ment-one"},
                        {"text": "segment2", "visual": "seg-ment-two"}
                    ]
                }
            `;

            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                currentSentence = data.sentence;
                
                elements.contentArea.innerHTML = `
                    <h2 class="text-xl md:text-2xl font-bold leading-snug break-words">${data.sentence}</h2>
                    <p class="ipa-text text-sm mt-2 tracking-wide">${data.ipa}</p>
                    <div class="mt-3 p-3 bg-slate-800 rounded-lg border border-slate-700 text-left">
                        <p class="text-slate-300 text-sm font-medium">ç¿»è­¯ï¼š${data.translation}</p>
                    </div>
                `;

                renderDrills(data.drills);
                
                // Show Main Practice Section (faded in)
                elements.mainPracticeSection.classList.remove('hidden');
                setTimeout(() => elements.mainPracticeSection.classList.remove('opacity-50'), 100);

                elements.examPointDisplay.textContent = data.exam_point || "ç„¡";
                elements.grammarNote.textContent = data.grammar || "ç„¡";
                elements.learningSection.classList.remove('hidden');
                
            } catch (e) {
                elements.contentArea.innerHTML = `<p class="text-red-400 text-xs">${e.message}</p>`;
            } finally {
                elements.generateBtn.disabled = false;
                isProcessing = false;
            }
        }

        async function analyzeDrill(userText, targetText) {
            elements.drillScoreModal.classList.remove('hidden');
            elements.drillTargetText.textContent = targetText;
            elements.drillScoreDisplay.innerHTML = '<span class="loading-dots text-2xl">è©•åˆ†ä¸­</span>';
            elements.drillComment.textContent = 'åˆ†æé€£éŸ³ä¸­...';

            const prompt = `
                Role: Drill Coach.
                Target: "${targetText}"
                User: "${userText}"
                Task: Score ONLY this short segment. Strict on linking.
                Return JSON: {"score": 0-100, "comment": "Brief TC feedback"}
            `;

            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                elements.drillScoreDisplay.textContent = data.score;
                elements.drillComment.textContent = data.comment;
            } catch(e) {
                elements.drillScoreDisplay.textContent = "ERR";
                elements.drillComment.textContent = "åˆ†æå¤±æ•—";
            }
        }

        async function analyzePronunciation(text) {
            elements.geminiAnalysis.innerHTML = '<div class="loading-dots">å®Œæ•´åˆ†æä¸­</div>';
            elements.feedbackSection.classList.remove('hidden');
            elements.feedbackSection.scrollIntoView({behavior:'smooth'});

            const prompt = `
                Role: Strict TOEIC Coach.
                Target: "${currentSentence}". User: "${text}".
                Return JSON:
                {
                    "score": 0-100,
                    "breakdown": {"accuracy": "0-100", "fluency": "0-100"},
                    "weakness": ["List errors"],
                    "comment": "Strict TC feedback."
                }
            `;
            
            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                elements.scoreDisplay.textContent = data.score;
                elements.accuracyScore.textContent = data.breakdown?.accuracy;
                elements.fluencyScore.textContent = data.breakdown?.fluency;
                
                const wList = data.weakness || [];
                elements.weaknessList.innerHTML = wList.length ? wList.map(w=>`<li>${w}</li>`).join('') : '<li class="text-green-400">Perfect</li>';
                elements.geminiAnalysis.innerHTML = data.comment;
            } catch (e) {
                elements.geminiAnalysis.textContent = "åˆ†æå¤±æ•—";
            }
        }

        async function callGemini(prompt, isJson, retry = 0) {
            const models = ['gemini-2.5-flash-preview-09-2025', 'gemini-1.5-flash'];
            const model = models[retry % models.length];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const body = { 
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: isJson ? { responseMimeType: "application/json" } : {}
            };

            const res = await fetch(url, { method: 'POST', body: JSON.stringify(body) });
            if (!res.ok) {
                if (res.status === 429 && retry < 2) {
                    await new Promise(r => setTimeout(r, 2000));
                    return callGemini(prompt, isJson, retry + 1);
                }
                const err = await res.json().catch(()=>({}));
                throw new Error(err.error?.message || res.statusText);
            }
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
        }

        function speak(text) {
            if (!text) return;
            window.speechSynthesis.cancel();
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'en-US';
            currentUtterance.rate = parseFloat(elements.rateInput.value) || 1;
            if (availableVoices.length === 0) populateVoices();
            const preferredVoice = availableVoices.find(v => v.name === 'Google US English') || availableVoices.find(v => v.lang === 'en-US');
            if (preferredVoice) currentUtterance.voice = preferredVoice;
            window.speechSynthesis.speak(currentUtterance);
        }
    </script>
</body>
</html>
