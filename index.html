<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TOEIC 750+ è½åŠ›åå°„æ•™ç·´</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230f172a%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ğŸ§</text></svg>">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRPRUlDIDc1MCsgQ29hY2giLAogICJzaG9ydF9uYW1lIjogIlRPRUlDIFJlZmxleCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzNhIiwKICAidGhlbWVfY29sb3IiOiAiIzBmMTczYSIsCiAgImljb25zIjogW3sKICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sOzY0LDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+OpywvdGV4dD48L3N2Zz4iLAogICAgInNpemVzIjogIjE5MngxOTIiLAogICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICB9XQp9">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text { background: linear-gradient(to right, #4ade80, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ipa-text { font-family: 'Arial', sans-serif; color: #94a3b8; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #334155; border-radius: 99px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -7px; border: 2px solid #1e293b; }
        
        audio { height: 30px; width: 100%; border-radius: 15px; margin-top: 5px; }
        audio::-webkit-media-controls-panel { background-color: #1e293b; }
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display { color: #fff; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center p-4">

    <header class="w-full max-w-2xl mt-2 mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">TOEIC <span class="gradient-text">Reflex</span></h1>
            <p class="text-slate-400 text-[10px]">è½èªªé›™ä¿®ãƒ»èªéŸ³åå°„æ•™ç·´</p>
        </div>
        <div class="flex gap-2">
            <button id="wakeLockBtn" class="text-slate-500 hover:text-yellow-400 p-2 transition" title="ä¿æŒè¢å¹•å¸¸äº®"><i class="fas fa-lightbulb"></i></button>
            <button id="configBtn" class="text-slate-400 hover:text-white p-2"><i class="fas fa-cog fa-lg"></i></button>
        </div>
    </header>

    <div id="apiKeyPanel" class="hidden w-full max-w-2xl bg-slate-800 border border-slate-700 p-4 rounded-xl mb-4 shadow-xl animate-fade-in z-50">
        <label class="block text-xs text-slate-400 mb-2">Gemini API Key <span class="text-red-400">(å¿…å¡«)</span></label>
        <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500" placeholder="Paste key here...">
        <div class="text-[10px] text-slate-500 mt-1">
            * è«‹è‡³ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">Google AI Studio</a> ç”³è«‹ã€‚Key åƒ…å„²å­˜æ–¼æ‚¨çš„æ‰‹æ©Ÿç«¯ã€‚
        </div>
        <button id="saveKeyBtn" class="mt-3 w-full bg-blue-600 hover:bg-blue-500 text-sm font-bold py-2 rounded-lg transition">å„²å­˜è¨­å®š</button>
    </div>

    <!-- Score Info Modal -->
    <div id="scoreInfoModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl max-w-sm w-full shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4 text-white">åš´æ ¼è©•åˆ†æ¨™æº–</h3>
            <ul class="space-y-4 text-sm">
                <li class="flex gap-3">
                    <span class="text-yellow-400 font-bold w-12">90+</span>
                    <div class="text-slate-300">
                        <strong class="text-white">Native (æ¯èªæ„Ÿ)</strong><br>
                        é€£éŸ³å®Œç¾ï¼Œèªèª¿è‡ªç„¶ï¼Œç¯€å¥å¼·å¼±åˆ†æ˜ã€‚
                    </div>
                </li>
                <li class="flex gap-3">
                    <span class="text-green-400 font-bold w-12">75-89</span>
                    <div class="text-slate-300">
                        <strong class="text-white">Business (å•†å‹™ç´š)</strong><br>
                        æ¸…æ™°å¯æ‡‚ï¼Œä½†é€£éŸ³(Linking)æˆ–è®ŠéŸ³(Flap T)å¶æœ‰éºæ¼ã€‚
                    </div>
                </li>
                <li class="flex gap-3">
                    <span class="text-blue-400 font-bold w-12">60-74</span>
                    <div class="text-slate-300">
                        <strong class="text-white">Student (å­¸è¡“è…”)</strong><br>
                        ç™¼éŸ³ç”Ÿç¡¬ï¼Œæ¯å€‹å­—éƒ½åˆ‡é–‹å”¸ï¼Œç¼ºä¹è‹±èªæµå‹•æ„Ÿã€‚
                    </div>
                </li>
            </ul>
            <button class="mt-6 w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg" onclick="document.getElementById('scoreInfoModal').classList.add('hidden')">äº†è§£</button>
        </div>
    </div>

    <main class="w-full max-w-2xl space-y-4 flex-1">
        
        <div id="httpsWarning" class="hidden bg-yellow-500/20 border border-yellow-500/50 text-yellow-200 p-4 rounded-xl text-sm">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>éƒ¨ç½²éŒ¯èª¤ï¼š</strong> è«‹ä½¿ç”¨ Vercel æˆ– Netlify ç­‰æ”¯æ´ HTTPS çš„å¹³å°ã€‚
        </div>

        <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-2xl p-5 shadow-2xl">
            <div class="flex gap-2 mb-4">
                <select id="levelSelect" class="bg-slate-900 border border-slate-700 text-sm rounded-lg px-2 py-2 outline-none w-full truncate font-bold text-blue-200">
                    <option value="L1">L1: èªéŸ³æ‰‹è¡“ (é€£éŸ³/è®ŠéŸ³)</option>
                    <option value="L2">L2: ç¯€å¥çŒè¼¸ (é‡éŸ³/èªèª¿)</option>
                    <option value="L3">L3: è·Ÿè®€æ¨¡ä»¿ (Part 3/4)</option>
                    <option value="L4">L4: é€Ÿåº¦æŠ—å£“ (1.2x)</option>
                </select>
                <button id="generateBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-2 rounded-lg transition whitespace-nowrap flex items-center gap-2 shadow-lg shadow-blue-900/20">
                    <i class="fas fa-magic"></i><span>å‡ºé¡Œ</span>
                </button>
            </div>

            <div id="contentArea" class="min-h-[140px] flex flex-col justify-center items-center text-center space-y-4">
                <p class="text-slate-500 text-sm italic">è¼¸å…¥ Key å¾Œé»æ“Šã€Œå‡ºé¡Œã€é–‹å§‹è¨“ç·´</p>
            </div>
        </div>

        <!-- Drill Section -->
        <div id="drillSection" class="hidden animate-fade-in px-2">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">é€£éŸ³æ‹†è§£ç‰¹è¨“</span>
                <div class="h-px bg-slate-700 flex-1"></div>
            </div>
            <div id="drillContainer" class="flex flex-wrap gap-2 justify-center"></div>
        </div>

        <div id="actionButtons" class="grid grid-cols-1 gap-4 opacity-50 pointer-events-none transition-opacity">
            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 space-y-4">
                <div class="flex items-center gap-3">
                    <span class="text-xs text-slate-400 font-medium whitespace-nowrap"><i class="fas fa-tachometer-alt mr-1"></i></span>
                    <input type="range" id="rateInput" min="0.5" max="1.5" step="0.1" value="1" class="w-full">
                    <span id="rateValue" class="text-xs text-blue-400 font-mono w-8 text-right">1.0x</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="ttsBtn" class="bg-slate-700 active:bg-slate-600 text-white py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation">
                        <i id="speakerIcon" class="fas fa-volume-up text-xl"></i><span id="ttsText" class="text-xs">æ’­æ”¾æ•´å¥</span>
                    </button>
                    <button id="recordBtn" class="bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation">
                        <i id="micIcon" class="fas fa-microphone text-xl"></i><span id="recordText" class="text-xs">é»æ“ŠéŒ„éŸ³</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Learning Section -->
        <div id="learningSection" class="hidden space-y-4 animate-fade-in">
            <div class="bg-blue-900/10 border border-blue-800/50 rounded-2xl p-5">
                <div class="space-y-3">
                    <div>
                        <h3 class="text-blue-400 font-bold text-xs uppercase tracking-wider mb-1">
                            <i class="fas fa-star mr-1"></i>è½åŠ›ç›²é»
                        </h3>
                        <p id="examPointDisplay" class="text-slate-200 text-sm font-medium leading-relaxed"></p>
                    </div>
                    <div class="h-px bg-blue-800/30"></div>
                    <div>
                        <h3 class="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">
                            <i class="fas fa-book mr-1"></i>æ–‡æ³•çµæ§‹
                        </h3>
                        <div id="grammarNote" class="text-slate-300 text-xs space-y-1 leading-relaxed"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback -->
        <div id="feedbackSection" class="hidden space-y-4 animate-fade-in pb-8">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl p-5 shadow-lg">
                <div class="flex justify-between items-end mb-4 border-b border-slate-700 pb-4">
                    <div>
                        <h3 class="font-bold text-slate-200 text-sm flex items-center gap-2">
                            æ•™ç·´è¨ºæ–· 
                            <button onclick="document.getElementById('scoreInfoModal').classList.remove('hidden')" class="text-slate-500 hover:text-blue-400"><i class="fas fa-question-circle"></i></button>
                        </h3>
                        <div class="flex gap-2 mt-1 text-[10px] text-slate-400">
                            <span>æº–ç¢ºåº¦: <span id="accuracyScore" class="text-white font-mono">--</span></span>
                            <span>|</span>
                            <span>æµæš¢åº¦: <span id="fluencyScore" class="text-white font-mono">--</span></span>
                        </div>
                    </div>
                    <div id="scoreDisplay" class="text-4xl font-black gradient-text">--</div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-red-900/10 border border-red-900/30 rounded-lg p-3">
                        <h4 class="text-red-400 text-xs font-bold mb-2 flex items-center gap-2"><i class="fas fa-stethoscope"></i> ç™¼éŸ³æ‰‹è¡“å®¤</h4>
                        <ul id="weaknessList" class="text-slate-300 text-sm space-y-1 list-disc list-inside">
                            <li class="text-slate-500 text-xs italic">ç­‰å¾…åˆ†æ...</li>
                        </ul>
                    </div>

                    <div id="geminiAnalysis" class="text-slate-300 text-sm leading-relaxed bg-slate-900/50 p-3 rounded-lg"></div>

                    <!-- Audio Player -->
                    <div id="audioPlayerContainer" class="hidden bg-slate-900 p-3 rounded-lg border border-slate-800">
                        <p class="text-xs text-slate-500 mb-1 flex justify-between">
                            <span>æˆ‘çš„éŒ„éŸ³</span>
                            <span class="text-blue-400 text-[10px]">å›æ”¾æª¢æŸ¥</span>
                        </p>
                        <audio id="userAudio" controls playsinline></audio>
                    </div>

                    <div class="bg-slate-900 p-3 rounded-lg border border-slate-800">
                        <p class="text-xs text-slate-500 mb-1">è¾¨è­˜æ–‡å­—ï¼š</p>
                        <p id="userSaidDisplay" class="text-red-400 text-sm italic min-h-[1.2em] break-words"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        const LEAKED_KEY_PREFIX = 'AIzaSyCvFOB';
        
        let currentSentence = '';
        let isRecording = false;
        let isProcessing = false;
        let recognition = null;
        
        // --- Improved Recording State ---
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;
        let finalTranscriptBuffer = ''; // Separate buffer for stability

        let currentUtterance = null;
        let availableVoices = [];

        const elements = {
            configBtn: document.getElementById('configBtn'),
            wakeLockBtn: document.getElementById('wakeLockBtn'),
            apiKeyPanel: document.getElementById('apiKeyPanel'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveKeyBtn: document.getElementById('saveKeyBtn'),
            generateBtn: document.getElementById('generateBtn'),
            genBtnText: document.getElementById('genBtnText'),
            contentArea: document.getElementById('contentArea'),
            actionButtons: document.getElementById('actionButtons'),
            rateInput: document.getElementById('rateInput'),
            rateValue: document.getElementById('rateValue'),
            ttsBtn: document.getElementById('ttsBtn'),
            speakerIcon: document.getElementById('speakerIcon'),
            recordBtn: document.getElementById('recordBtn'),
            recordText: document.getElementById('recordText'),
            micIcon: document.getElementById('micIcon'),
            drillSection: document.getElementById('drillSection'),
            drillContainer: document.getElementById('drillContainer'),
            learningSection: document.getElementById('learningSection'),
            examPointDisplay: document.getElementById('examPointDisplay'),
            grammarNote: document.getElementById('grammarNote'),
            feedbackSection: document.getElementById('feedbackSection'),
            userSaidDisplay: document.getElementById('userSaidDisplay'),
            scoreDisplay: document.getElementById('scoreDisplay'),
            accuracyScore: document.getElementById('accuracyScore'),
            fluencyScore: document.getElementById('fluencyScore'),
            weaknessList: document.getElementById('weaknessList'),
            geminiAnalysis: document.getElementById('geminiAnalysis'),
            levelSelect: document.getElementById('levelSelect'),
            audioPlayerContainer: document.getElementById('audioPlayerContainer'),
            userAudio: document.getElementById('userAudio')
        };

        function populateVoices() { availableVoices = window.speechSynthesis.getVoices(); }
        populateVoices();
        if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = populateVoices;

        function checkAndInitKey() {
            if (apiKey && apiKey.startsWith(LEAKED_KEY_PREFIX)) {
                localStorage.removeItem('gemini_api_key');
                apiKey = '';
            }
            if (apiKey) {
                elements.apiKeyInput.value = apiKey;
                elements.contentArea.innerHTML = `<div class="text-slate-500 text-sm italic animate-pulse"><i class="fas fa-check-circle text-green-500 mr-2"></i>æ•™ç·´å·²å°±ç·’ï¼Œè«‹é¸æ“‡ Level</div>`;
                elements.generateBtn.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');
            } else {
                elements.apiKeyPanel.classList.remove('hidden');
            }
        }
        checkAndInitKey();

        if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            document.getElementById('httpsWarning').classList.remove('hidden');
        }

        elements.configBtn.addEventListener('click', () => elements.apiKeyPanel.classList.toggle('hidden'));
        elements.saveKeyBtn.addEventListener('click', () => {
            const inputVal = elements.apiKeyInput.value.trim();
            if (inputVal) {
                if (inputVal.startsWith(LEAKED_KEY_PREFIX)) { alert("æ­¤ Key å·²å¤±æ•ˆ"); return; }
                apiKey = inputVal;
                localStorage.setItem('gemini_api_key', apiKey);
                elements.apiKeyPanel.classList.add('hidden');
                checkAndInitKey();
            } else { alert('è«‹è¼¸å…¥ API Key'); }
        });

        elements.rateInput.addEventListener('input', (e) => elements.rateValue.textContent = e.target.value + 'x');
        elements.generateBtn.addEventListener('click', generateSentence);
        elements.ttsBtn.addEventListener('click', () => speak(currentSentence));

        elements.wakeLockBtn.addEventListener('click', async () => {
            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); elements.wakeLockBtn.classList.add('text-yellow-400'); alert("è¢å¹•å¸¸äº®ï¼šON"); } catch (err) { console.error(err); }
            }
        });

        // --- Helper: Get Supported Mime Type for Mobile ---
        const getMimeType = () => {
            const types = ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) return type;
            }
            return ''; // Let browser use default
        };

        // --- Unified Recording Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // Toggle Recording
        elements.recordBtn.addEventListener('click', async () => {
            if (isRecording) {
                stopAllRecording();
            } else {
                await startAllRecording();
            }
        });

        async function startAllRecording() {
            if (!SpeechRecognition) { alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜"); return; }

            try {
                // 1. Get Stream First (Permission Gesture)
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Start Audio Recorder
                audioChunks = [];
                const options = { mimeType: getMimeType() };
                try {
                    mediaRecorder = new MediaRecorder(audioStream, options.mimeType ? options : undefined);
                } catch(e) {
                    mediaRecorder = new MediaRecorder(audioStream); // Fallback
                }
                
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    elements.userAudio.src = URL.createObjectURL(blob);
                    elements.audioPlayerContainer.classList.remove('hidden');
                };
                mediaRecorder.start();

                // 3. Start Speech Recognition
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                finalTranscriptBuffer = ''; // Reset Buffer

                recognition.onresult = (event) => {
                    let interimStr = '';
                    // Rebuild transcript from scratch to avoid duplication bug
                    let fullFinal = '';
                    
                    for (let i = 0; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            fullFinal += event.results[i][0].transcript;
                        } else {
                            interimStr += event.results[i][0].transcript;
                        }
                    }
                    finalTranscriptBuffer = fullFinal; // Store reliable final
                    elements.userSaidDisplay.innerHTML = `<span class="text-white">${fullFinal}</span><span class="text-slate-500">${interimStr}</span>`;
                };

                recognition.onend = () => {
                    // Auto-restart if we didn't manually stop (Android sometimes stops early)
                    // But here we rely on manual stop mainly.
                };

                recognition.start();
                
                // UI Updates
                isRecording = true;
                elements.recordBtn.className = "bg-red-600 text-white border border-red-600 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation shadow-lg shadow-red-900/50";
                elements.micIcon.classList.add('animate-pulse');
                elements.recordText.textContent = 'åœæ­¢ä¸¦åˆ†æ';
                
                // Clear previous
                elements.feedbackSection.classList.remove('hidden');
                elements.userSaidDisplay.textContent = '...';
                elements.scoreDisplay.textContent = '--';
                elements.accuracyScore.textContent = '--';
                elements.fluencyScore.textContent = '--';
                elements.weaknessList.innerHTML = '<li class="text-slate-500 text-xs italic">ç­‰å¾…åˆ†æ...</li>';
                elements.geminiAnalysis.textContent = '';
                elements.audioPlayerContainer.classList.add('hidden');
                elements.userAudio.src = "";
                
                elements.feedbackSection.scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                console.error("Recording Start Error:", err);
                alert("ç„¡æ³•å•Ÿå‹•éŒ„éŸ³: " + err.message + "\nè«‹ç¢ºèªå·²å…è¨±éº¥å…‹é¢¨æ¬Šé™ä¸”ä½¿ç”¨ HTTPSã€‚");
            }
        }

        function stopAllRecording() {
            isRecording = false;
            
            // Stop Audio
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(track => track.stop());

            // Stop Recognition
            if (recognition) {
                recognition.stop();
                // Check buffer + any interim that might be left in UI
                setTimeout(() => {
                    const textToAnalyze = elements.userSaidDisplay.innerText.trim();
                    if (textToAnalyze.length > 0 && textToAnalyze !== '...') {
                        analyzePronunciation(textToAnalyze);
                    } else if (finalTranscriptBuffer.trim().length > 0) {
                        analyzePronunciation(finalTranscriptBuffer);
                    } else {
                        elements.userSaidDisplay.textContent = "(æœªåµæ¸¬åˆ°èªéŸ³ï¼Œè«‹é è¿‘éº¥å…‹é¢¨é‡è©¦)";
                    }
                }, 500); // Wait a bit for final events
            }

            // UI Reset
            elements.recordBtn.className = "bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation";
            elements.micIcon.classList.remove('animate-pulse');
            elements.recordText.textContent = 'é‡æ–°éŒ„éŸ³';
        }

        // --- Main Logic (Unchanged) ---
        async function generateSentence() {
            if (isProcessing) return;
            if (!apiKey) { elements.apiKeyPanel.classList.remove('hidden'); return; }
            
            isProcessing = true;
            elements.generateBtn.disabled = true;
            elements.contentArea.innerHTML = '<div class="loading-dots text-slate-500">æ•™ç·´å‡ºé¡Œä¸­</div>';
            elements.drillSection.classList.add('hidden');
            elements.learningSection.classList.add('hidden');
            elements.feedbackSection.classList.add('hidden');
            elements.generateBtn.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');

            const level = elements.levelSelect.value;
            let focusPrompt = "";
            
            if (level === 'L1') focusPrompt = "Focus: Phonetic Coding. Generate short sentences packed with Linking (Consonant+Vowel) and Flap T.";
            else if (level === 'L2') focusPrompt = "Focus: Rhythm. Generate sentences where stress is crucial.";
            else if (level === 'L3') focusPrompt = "Focus: Shadowing. Generate longer Part 3 style sentences.";
            else if (level === 'L4') focusPrompt = "Focus: Speed. Generate complex sentences.";

            const prompt = `
                Role: TOEIC Pronunciation Coach for Experts (Doctoral level).
                ${focusPrompt}
                Task: Generate a business English sentence.
                Constraint: 50% chance to use "It" as a dummy subject.
                
                Return JSON only:
                {
                    "sentence": "English sentence",
                    "ipa": "IPA with linking markers",
                    "translation": "TC translation",
                    "tips": "Brief linking tip",
                    "grammar": "Brief syntax analysis (TC)",
                    "exam_point": "Key TOEIC exam point (TC)",
                    "drills": [
                        {"text": "segment", "ipa": "IPA", "visual": "visual-guide (e.g. che-ki-tout)"},
                        {"text": "segment2", "ipa": "IPA", "visual": "visual-guide"}
                    ]
                }
                * drills: Select 2-3 difficult linking clusters from the sentence for independent practice.
            `;

            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                currentSentence = data.sentence;
                
                elements.contentArea.innerHTML = `
                    <h2 class="text-xl md:text-2xl font-bold leading-snug break-words">${data.sentence}</h2>
                    <p class="ipa-text text-sm mt-2 tracking-wide">${data.ipa}</p>
                    <p class="text-blue-400 text-[10px] mt-2 inline-block border border-blue-900/50 px-2 py-1 rounded bg-blue-900/10">${data.tips}</p>
                    <div class="mt-4 p-3 bg-slate-800 rounded-lg border border-slate-700">
                        <p class="text-slate-300 text-sm font-medium">ç¿»è­¯ï¼š${data.translation}</p>
                    </div>
                `;

                if (data.drills && data.drills.length > 0) {
                    elements.drillContainer.innerHTML = data.drills.map(d => `
                        <button onclick="speak('${d.text}')" class="bg-slate-700 hover:bg-slate-600 active:bg-blue-600 border border-slate-600 rounded-lg px-3 py-2 flex flex-col items-center min-w-[80px] transition group">
                            <span class="text-xs text-slate-300 group-hover:text-white mb-1">${d.text}</span>
                            <span class="text-[10px] text-blue-400 font-mono tracking-tighter">${d.visual}</span>
                            <i class="fas fa-volume-up text-[10px] text-slate-500 mt-1"></i>
                        </button>
                    `).join('');
                    elements.drillSection.classList.remove('hidden');
                }

                elements.examPointDisplay.textContent = data.exam_point || "ç„¡è€ƒé»è³‡æ–™";
                elements.grammarNote.innerHTML = data.grammar ? data.grammar.split('\n').map(l => `<p>${l}</p>`).join('') : "ç„¡æ–‡æ³•è³‡æ–™";
                
                elements.learningSection.classList.remove('hidden');
                elements.actionButtons.classList.remove('opacity-50', 'pointer-events-none');
            } catch (e) {
                elements.contentArea.innerHTML = `<p class="text-red-400 text-xs">${e.message}</p>`;
            } finally {
                elements.generateBtn.disabled = false;
                isProcessing = false;
            }
        }

        async function analyzePronunciation(text) {
            elements.geminiAnalysis.innerHTML = '<div class="loading-dots">èªéŸ³æ‰‹è¡“é€²è¡Œä¸­</div>';
            
            const prompt = `
                Role: Strict TOEIC Coach.
                Target: "${currentSentence}".
                User: "${text}".
                Criteria: Accuracy (40%), Fluency (30%), Completeness (30%).
                Return JSON ONLY:
                {
                    "score": 0-100,
                    "breakdown": {"accuracy": "0-100", "fluency": "0-100"},
                    "weakness": ["List specific missing links", "Intonation errors"],
                    "comment": "Strict feedback in TC."
                }
            `;
            
            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                
                elements.scoreDisplay.textContent = data.score;
                elements.accuracyScore.textContent = data.breakdown?.accuracy || '--';
                elements.fluencyScore.textContent = data.breakdown?.fluency || '--';
                
                if (data.weakness && data.weakness.length > 0) {
                    elements.weaknessList.innerHTML = data.weakness.map(w => `<li class="text-red-300">${w}</li>`).join('');
                } else {
                    elements.weaknessList.innerHTML = '<li class="text-green-400">Perfect! é€£éŸ³èˆ‡ç¯€å¥å®Œç¾ã€‚</li>';
                }
                elements.geminiAnalysis.innerHTML = data.comment;
                
            } catch (e) { 
                elements.geminiAnalysis.textContent = "åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦"; 
                console.error(e);
            }
        }

        async function callGemini(prompt, isJson, retry = 0) {
            const models = ['gemini-2.5-flash-preview-09-2025', 'gemini-1.5-flash'];
            const model = models[retry % models.length];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const body = { 
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: isJson ? { responseMimeType: "application/json" } : {}
            };

            const res = await fetch(url, { method: 'POST', body: JSON.stringify(body) });
            if (!res.ok) {
                if (res.status === 429 && retry < 2) {
                    await new Promise(r => setTimeout(r, 2000));
                    return callGemini(prompt, isJson, retry + 1);
                }
                const err = await res.json().catch(()=>({}));
                throw new Error(err.error?.message || res.statusText);
            }
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
        }

        function speak(text) {
            if (!text) return;
            window.speechSynthesis.cancel();
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'en-US';
            currentUtterance.rate = parseFloat(elements.rateInput.value) || 1;
            if (availableVoices.length === 0) populateVoices();
            const preferredVoice = availableVoices.find(v => v.name === 'Google US English') || availableVoices.find(v => v.lang === 'en-US');
            if (preferredVoice) currentUtterance.voice = preferredVoice;
            elements.speakerIcon.classList.add('animate-ping');
            currentUtterance.onend = () => elements.speakerIcon.classList.remove('animate-ping');
            window.speechSynthesis.speak(currentUtterance);
        }
    </script>
</body>
</html>
