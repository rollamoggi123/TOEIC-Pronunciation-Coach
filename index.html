<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TOEIC 750+ è½åŠ›åå°„æ•™ç·´</title>
    
    <!-- PWA Icon & Manifest (Base64 Embedded for Single File Portability) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230f172a%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ğŸ§</text></svg>">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRPRUlDIDc1MCsgQ29hY2giLAogICJzaG9ydF9uYW1lIjogIlRPRUlDIFJlZmxleCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzNhIiwKICAidGhlbWVfY29sb3IiOiAiIzBmMTczYSIsCiAgImljb25zIjogW3sKICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sOzY0LDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+OpywvdGV4dD48L3N2Zz4iLAogICAgInNpemVzIjogIjE5MngxOTIiLAogICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICB9XQp9">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        /* Mobile Viewport Fixes */
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .gradient-text { background: linear-gradient(to right, #4ade80, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ipa-text { font-family: 'Arial', sans-serif; color: #94a3b8; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        /* Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #334155; border-radius: 99px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -7px; border: 2px solid #1e293b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center p-4">

    <header class="w-full max-w-2xl mt-2 mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">TOEIC <span class="gradient-text">Reflex</span></h1>
            <p class="text-slate-400 text-[10px]">AI è½åŠ›åå°„æ•™ç·´</p>
        </div>
        <div class="flex gap-2">
            <button id="wakeLockBtn" class="text-slate-500 hover:text-yellow-400 p-2 transition" title="ä¿æŒè¢å¹•å¸¸äº®"><i class="fas fa-lightbulb"></i></button>
            <button id="configBtn" class="text-slate-400 hover:text-white p-2"><i class="fas fa-cog fa-lg"></i></button>
        </div>
    </header>

    <div id="apiKeyPanel" class="hidden w-full max-w-2xl bg-slate-800 border border-slate-700 p-4 rounded-xl mb-4 shadow-xl animate-fade-in z-50">
        <label class="block text-xs text-slate-400 mb-2">Gemini API Key <span class="text-red-400">(å¿…å¡«)</span></label>
        <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500" placeholder="Paste key here...">
        <div class="text-[10px] text-slate-500 mt-1">
            * è«‹è‡³ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">Google AI Studio</a> ç”³è«‹ã€‚Key åƒ…å„²å­˜æ–¼æ‚¨çš„æ‰‹æ©Ÿç«¯ã€‚
        </div>
        <button id="saveKeyBtn" class="mt-3 w-full bg-blue-600 hover:bg-blue-500 text-sm font-bold py-2 rounded-lg transition">å„²å­˜è¨­å®š</button>
    </div>

    <main class="w-full max-w-2xl space-y-4 flex-1">
        
        <!-- HTTPS Warning -->
        <div id="httpsWarning" class="hidden bg-yellow-500/20 border border-yellow-500/50 text-yellow-200 p-4 rounded-xl text-sm">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>éƒ¨ç½²éŒ¯èª¤ï¼š</strong> è«‹ä½¿ç”¨ Vercel æˆ– Netlify ç­‰æ”¯æ´ HTTPS çš„å¹³å°ã€‚
        </div>

        <!-- Dashboard -->
        <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-2xl p-5 shadow-2xl">
            <div class="flex gap-2 mb-4">
                <select id="levelSelect" class="bg-slate-900 border border-slate-700 text-sm rounded-lg px-2 py-2 outline-none w-full truncate">
                    <option value="L1">L1: èªéŸ³æ‹†è§£ (åŸºç¤)</option>
                    <option value="L2">L2: é—œéµå­—å°èˆª</option>
                    <option value="L3">L3: å•†å‹™å ´æ™¯</option>
                    <option value="L4">L4: æ¥µé™èªé€Ÿ</option>
                </select>
                <button id="generateBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-2 rounded-lg transition whitespace-nowrap flex items-center gap-2 shadow-lg shadow-blue-900/20">
                    <i class="fas fa-magic"></i><span>å‡ºé¡Œ</span>
                </button>
            </div>

            <div id="contentArea" class="min-h-[140px] flex flex-col justify-center items-center text-center space-y-4">
                <p class="text-slate-500 text-sm italic">è¼¸å…¥ Key å¾Œé»æ“Šã€Œå‡ºé¡Œã€é–‹å§‹</p>
            </div>
        </div>

        <!-- Controls -->
        <div id="actionButtons" class="grid grid-cols-1 gap-4 opacity-50 pointer-events-none transition-opacity">
            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 space-y-4">
                <div class="flex items-center gap-3">
                    <span class="text-xs text-slate-400 font-medium whitespace-nowrap"><i class="fas fa-tachometer-alt mr-1"></i></span>
                    <input type="range" id="rateInput" min="0.5" max="1.5" step="0.1" value="1" class="w-full">
                    <span id="rateValue" class="text-xs text-blue-400 font-mono w-8 text-right">1.0x</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="ttsBtn" class="bg-slate-700 active:bg-slate-600 text-white py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation">
                        <i id="speakerIcon" class="fas fa-volume-up text-xl"></i><span id="ttsText" class="text-xs">æ’­æ”¾ç¯„ä¾‹</span>
                    </button>
                    <!-- Improved Record Button visual feedback -->
                    <button id="recordBtn" class="bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation">
                        <i id="micIcon" class="fas fa-microphone text-xl"></i><span id="recordText" class="text-xs">é»æ“ŠéŒ„éŸ³</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback -->
        <div id="feedbackSection" class="hidden space-y-4 animate-fade-in pb-8">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl p-5 shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-slate-200 text-sm">æ•™ç·´è©•åˆ†</h3>
                    <div id="scoreDisplay" class="text-3xl font-black gradient-text">--</div>
                </div>
                <div class="space-y-3">
                    <div class="bg-slate-900 p-3 rounded-lg border border-slate-800">
                        <p class="text-xs text-slate-500 mb-1">ä½ èªªçš„æ˜¯ï¼š</p>
                        <p id="userSaidDisplay" class="text-red-400 text-sm italic min-h-[1.2em]"></p>
                    </div>
                    <div id="geminiAnalysis" class="text-slate-300 text-sm leading-relaxed"></div>
                </div>
            </div>

            <div id="grammarSection" class="bg-blue-900/10 border border-blue-800/50 rounded-2xl p-5">
                <h3 class="text-blue-400 font-bold mb-2 flex items-center gap-2 text-sm">
                    <i class="fas fa-book-open"></i>å¤šç›Š 750 æ–‡æ³•æ‹†è§£
                </h3>
                <div id="grammarNote" class="text-slate-300 text-sm space-y-2"></div>
            </div>
        </div>
    </main>

    <script>
        // Init logic
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        const LEAKED_KEY_PREFIX = 'AIzaSyCvFOB';
        
        let currentSentence = '';
        let isRecording = false;
        let isProcessing = false;
        let recognition = null;
        let finalTranscript = '';
        let wakeLock = null;
        
        // Mobile TTS Fix: Global variable to prevent garbage collection
        let currentUtterance = null;
        let availableVoices = [];

        const elements = {
            configBtn: document.getElementById('configBtn'),
            wakeLockBtn: document.getElementById('wakeLockBtn'),
            apiKeyPanel: document.getElementById('apiKeyPanel'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveKeyBtn: document.getElementById('saveKeyBtn'),
            generateBtn: document.getElementById('generateBtn'),
            genBtnText: document.getElementById('genBtnText'),
            contentArea: document.getElementById('contentArea'),
            actionButtons: document.getElementById('actionButtons'),
            rateInput: document.getElementById('rateInput'),
            rateValue: document.getElementById('rateValue'),
            ttsBtn: document.getElementById('ttsBtn'),
            speakerIcon: document.getElementById('speakerIcon'),
            ttsText: document.getElementById('ttsText'),
            recordBtn: document.getElementById('recordBtn'),
            recordText: document.getElementById('recordText'),
            micIcon: document.getElementById('micIcon'),
            feedbackSection: document.getElementById('feedbackSection'),
            userSaidDisplay: document.getElementById('userSaidDisplay'),
            scoreDisplay: document.getElementById('scoreDisplay'),
            geminiAnalysis: document.getElementById('geminiAnalysis'),
            grammarNote: document.getElementById('grammarNote'),
            levelSelect: document.getElementById('levelSelect')
        };

        // --- Voices Loader (Essential for Mobile) ---
        function populateVoices() {
            availableVoices = window.speechSynthesis.getVoices();
        }
        populateVoices();
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = populateVoices;
        }

        // --- Init Checks ---
        function checkAndInitKey() {
            if (apiKey && apiKey.startsWith(LEAKED_KEY_PREFIX)) {
                localStorage.removeItem('gemini_api_key');
                apiKey = '';
                alert("æ¸¬è©¦ Key å·²éæœŸï¼Œè«‹è¨­å®šæ‚¨è‡ªå·±çš„ API Keyã€‚");
            }

            if (apiKey) {
                elements.apiKeyInput.value = apiKey;
                elements.contentArea.innerHTML = `
                    <div class="text-slate-500 text-sm italic animate-pulse">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>API Key å·²å°±ç·’
                    </div>
                `;
                elements.generateBtn.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');
            } else {
                elements.apiKeyPanel.classList.remove('hidden');
            }
        }
        checkAndInitKey();

        if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            document.getElementById('httpsWarning').classList.remove('hidden');
        }

        // --- Event Listeners ---
        elements.configBtn.addEventListener('click', () => elements.apiKeyPanel.classList.toggle('hidden'));
        
        elements.saveKeyBtn.addEventListener('click', () => {
            const inputVal = elements.apiKeyInput.value.trim();
            if (inputVal) {
                if (inputVal.startsWith(LEAKED_KEY_PREFIX)) {
                    alert("æ­¤ Key å·²å¤±æ•ˆï¼Œè«‹ä½¿ç”¨æ‚¨è‡ªå·±çš„ Keyã€‚");
                    return;
                }
                apiKey = inputVal;
                localStorage.setItem('gemini_api_key', apiKey);
                elements.apiKeyPanel.classList.add('hidden');
                checkAndInitKey();
            } else {
                alert('è«‹è¼¸å…¥ API Key');
            }
        });

        elements.rateInput.addEventListener('input', (e) => elements.rateValue.textContent = e.target.value + 'x');
        elements.generateBtn.addEventListener('click', generateSentence);
        elements.ttsBtn.addEventListener('click', () => speak(currentSentence));

        // --- Wake Lock ---
        elements.wakeLockBtn.addEventListener('click', async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    elements.wakeLockBtn.classList.remove('text-slate-500');
                    elements.wakeLockBtn.classList.add('text-yellow-400');
                    alert("è¢å¹•å¸¸äº®æ¨¡å¼ï¼šå·²é–‹å•Ÿ");
                } catch (err) { console.error(err); }
            } else {
                alert("ç€è¦½å™¨ä¸æ”¯æ´æ­¤åŠŸèƒ½");
            }
        });

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecording = true;
                finalTranscript = '';
                elements.recordBtn.className = "bg-red-600 text-white border border-red-600 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation shadow-lg shadow-red-900/50";
                elements.micIcon.classList.add('animate-pulse');
                elements.recordText.textContent = 'åœæ­¢ä¸¦åˆ†æ';
                elements.feedbackSection.classList.remove('hidden');
                elements.userSaidDisplay.textContent = '...';
                elements.feedbackSection.scrollIntoView({ behavior: 'smooth' });
            };

            recognition.onend = () => {
                isRecording = false;
                elements.recordBtn.className = "bg-red-600/20 active:bg-red-600/30 text-red-400 border border-red-600/50 py-4 rounded-xl flex flex-col items-center justify-center gap-1 transition touch-manipulation";
                elements.micIcon.classList.remove('animate-pulse');
                elements.recordText.textContent = 'é»æ“ŠéŒ„éŸ³';
                
                if (finalTranscript.trim().length > 0) {
                    analyzePronunciation(finalTranscript);
                }
            };

            recognition.onresult = (event) => {
                let interim = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                    else interim += event.results[i][0].transcript;
                }
                elements.userSaidDisplay.innerHTML = `<span class="text-white">${finalTranscript}</span><span class="text-slate-500">${interim}</span>`;
            };

            recognition.onerror = (event) => {
                console.error(event.error);
                if(isRecording && event.error !== 'no-speech') recognition.stop();
                if(event.error === 'not-allowed') alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™");
            };

            elements.recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    try { recognition.start(); } catch(e) { console.error(e); }
                }
            });
        } else {
            elements.recordBtn.disabled = true;
            elements.recordText.textContent = 'ä¸æ”¯æ´';
            alert("iOS è«‹ç”¨ Safariï¼ŒAndroid è«‹ç”¨ Chrome");
        }

        // --- Core Functions ---
        async function generateSentence() {
            if (isProcessing) return;
            if (!apiKey) {
                elements.apiKeyPanel.classList.remove('hidden');
                alert('è«‹å…ˆè¨­å®š API Key');
                return;
            }
            
            isProcessing = true;
            elements.generateBtn.disabled = true;
            elements.contentArea.innerHTML = '<div class="loading-dots text-slate-500">æ•™ç·´å‡ºé¡Œä¸­</div>';
            elements.feedbackSection.classList.add('hidden');
            elements.generateBtn.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');

            const prompt = `
                Act as a TOEIC coach. Level: ${elements.levelSelect.value}.
                Task: Generate a business sentence. 
                Constraint: 50% chance to use "It" as a dummy subject (e.g., "It is crucial to...").
                
                Return JSON only:
                {
                    "sentence": "English sentence",
                    "ipa": "IPA transcription",
                    "translation": "TC translation",
                    "tips": "Brief linking tip",
                    "grammar": "Brief grammar breakdown (TC)"
                }
            `;

            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                currentSentence = data.sentence;
                elements.contentArea.innerHTML = `
                    <h2 class="text-xl md:text-2xl font-bold leading-snug break-words">${data.sentence}</h2>
                    <p class="ipa-text text-sm mt-3 tracking-wide">${data.ipa}</p>
                    <div class="h-px w-8 bg-slate-700 mx-auto my-3"></div>
                    <p class="text-slate-400 text-xs">${data.translation}</p>
                    <p class="text-blue-400 text-[10px] mt-2 inline-block border border-blue-900/50 px-2 py-1 rounded bg-blue-900/10">${data.tips}</p>
                `;
                elements.grammarNote.innerHTML = data.grammar.split('\n').map(l => `<p>${l}</p>`).join('');
                elements.actionButtons.classList.remove('opacity-50', 'pointer-events-none');
            } catch (e) {
                elements.contentArea.innerHTML = `<p class="text-red-400 text-xs">${e.message}</p>`;
            } finally {
                elements.generateBtn.disabled = false;
                isProcessing = false;
            }
        }

        async function analyzePronunciation(text) {
            elements.geminiAnalysis.innerHTML = '<div class="loading-dots">åˆ†æä¸­</div>';
            const prompt = `
                Target: "${currentSentence}". User said: "${text}".
                Compare strict phonetics. Use TC.
                Return JSON: {"score": 0-100, "comment": "Advice"}
            `;
            try {
                const res = await callGemini(prompt, true);
                const data = JSON.parse(res);
                elements.scoreDisplay.textContent = data.score;
                elements.geminiAnalysis.innerHTML = data.comment;
            } catch (e) {
                elements.geminiAnalysis.textContent = "åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦";
            }
        }

        async function callGemini(prompt, isJson, retry = 0) {
            const models = ['gemini-2.5-flash-preview-09-2025', 'gemini-1.5-flash'];
            const model = models[retry % models.length];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const body = { 
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: isJson ? { responseMimeType: "application/json" } : {}
            };

            const res = await fetch(url, { method: 'POST', body: JSON.stringify(body) });
            
            if (!res.ok) {
                if (res.status === 429 && retry < 2) {
                    await new Promise(r => setTimeout(r, 2000));
                    return callGemini(prompt, isJson, retry + 1);
                }
                const err = await res.json().catch(()=>({}));
                throw new Error(err.error?.message || res.statusText);
            }
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
        }

        // --- Mobile TTS Fix ---
        function speak(text) {
            if (!text) return;
            
            // 1. Cancel previous
            window.speechSynthesis.cancel();

            // 2. Create utterance globally to avoid GC
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'en-US';
            currentUtterance.rate = parseFloat(elements.rateInput.value) || 1;
            currentUtterance.volume = 1.0;

            // 3. Smart Voice Selection (iOS/Android Compat)
            if (availableVoices.length === 0) populateVoices();
            const preferredVoice = availableVoices.find(v => v.name === 'Google US English') || 
                                   availableVoices.find(v => v.name === 'Samantha') ||
                                   availableVoices.find(v => v.lang === 'en-US');
            if (preferredVoice) currentUtterance.voice = preferredVoice;

            // 4. UI Feedback
            elements.speakerIcon.classList.add('animate-ping');
            currentUtterance.onend = () => {
                elements.speakerIcon.classList.remove('animate-ping');
            };
            currentUtterance.onerror = (e) => {
                console.error("TTS Error:", e);
                elements.speakerIcon.classList.remove('animate-ping');
            };

            // 5. Speak
            window.speechSynthesis.speak(currentUtterance);
        }
    </script>
</body>
</html>
